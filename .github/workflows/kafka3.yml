name: Kafka3

on:
  workflow_dispatch:

jobs:
  update-topicos-kafka:
    runs-on: ubuntu-latest
    environment: dev
    env:
      CONFIG_PATH: config.json

    steps:
      - name: Checkout reposit√≥rio principal
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get Content from Wiki
        env:
          WIKI_API_TOKEN: ${{ secrets.WIKI_API_TOKEN }}
        run: |
          echo "üîç Fetching content from Wiki.js..."
          QUERY=$(cat << EOF
          {         
            pages {
              single (id:27) {
                content
              }
            }
          }
          EOF
          )

          JSON_PAYLOAD=$(jq -n --arg q "$QUERY" '{query: $q}')

          RESPONSE=$(curl -s -X POST "https://wiki.franquinho.info/graphql" \
            -H "Authorization: Bearer $WIKI_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data "$JSON_PAYLOAD")

          echo "$RESPONSE" | jq -r '.data.pages.single.content' > wiki_content.md
          echo "‚úÖ Content saved to wiki_content.md"

      - name: Update Content
        run: |
          CONFIG_FILE="${{ env.CONFIG_PATH }}"
          topicName=$(jq -r '.metadata.topicName' "$CONFIG_FILE")
          topicDescription=$(jq -r '.metadata.topicDescription' "$CONFIG_FILE")
          link="https://dev.azure.com/CTTPortugal/Technology/_git/pt.technology.kafka.documentation?path=/$topicName"
          update="| $topicName | $topicDescription | [Link]($link) | Ativo |"

          echo "üîß Nova linha: $update"

          # Define o cabe√ßalho e separador da tabela exatamente
          table_header="| Nome do T√≥pico | Descri√ß√£o | Detalhes/Link Documenta√ß√£o | Estado |"
          table_separator="|--|--|--|--|"

          # Checa se o arquivo tem a tabela (pela linha do cabe√ßalho exato)
          if ! grep -Fq "$table_header" wiki_content.md; then
            echo "‚ö†Ô∏è Tabela n√£o encontrada. Adicionando tabela no final do arquivo."

            # Acrescenta a tabela no final, com cabe√ßalho, separador e a nova linha
            echo -e "\n$table_header\n$table_separator\n$update" >> wiki_content.md

          else
            # Extrai o conte√∫do antes da tabela, a tabela em si, e depois do fim da tabela

            # Obtem o n√∫mero da linha onde a tabela come√ßa (cabe√ßalho)
            start_line=$(grep -nF "$table_header" wiki_content.md | cut -d: -f1)
            # Obtem o n√∫mero da linha onde o separador da tabela est√° (linha ap√≥s o cabe√ßalho)
            sep_line=$((start_line + 1))

            # Agora vamos identificar onde a tabela termina (√∫ltima linha cont√≠nua que come√ßa com | ap√≥s o cabe√ßalho e separador)
            total_lines=$(wc -l < wiki_content.md)
            end_line=$sep_line

            while [ $end_line -lt $total_lines ]; do
              next_line=$((end_line + 1))
              line_content=$(sed -n "${next_line}p" wiki_content.md)
              if [[ "$line_content" =~ ^\| ]]; then
                end_line=$next_line
              else
                break
              fi
            done

            # Extrai partes do arquivo
            head_content=$(sed -n "1,$((start_line - 1))p" wiki_content.md)
            table_content=$(sed -n "$start_line,$end_line p" wiki_content.md)
            tail_content=$(sed -n "$((end_line + 1)),${total_lines}p" wiki_content.md)

            # Remove cabe√ßalho e separador para manipular s√≥ as linhas da tabela
            table_rows=$(echo "$table_content" | tail -n +3)

            # Verifica se o t√≥pico j√° est√° presente na tabela
            if echo "$table_rows" | grep -Fq "| $topicName |"; then
              echo "‚ö†Ô∏è T√≥pico '$topicName' j√° existe na tabela. Nenhuma altera√ß√£o feita."
            else
              echo "‚úÖ T√≥pico n√£o encontrado. Adicionando √† tabela e ordenando."

              # Acrescenta a nova linha
              table_rows=$(echo -e "$table_rows\n$update")

              # Ordena linhas alfabeticamente pelo campo do t√≥pico (campo 2 depois do pipe)
              table_rows=$(echo "$table_rows" | sort -t'|' -k2,2)

            fi

            # Reconstr√≥i o arquivo completo
            {
              echo "$head_content"
              echo "$table_header"
              echo "$table_separator"
              echo "$table_rows"
              echo "$tail_content"
            } > wiki_content.md

          fi

          # Copia para arquivo final que ser√° enviado ao Wiki.js
          cp wiki_content.md content_to_upload.md

          
          echo "‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è DEbug Contnet to update"
          head -30 content_to_upload.md | cat -n


      - name: Fetch current tags from Wiki.js
        env:
          WIKI_API_TOKEN: ${{ secrets.WIKI_API_TOKEN }}
        run: |
          QUERY=$(cat << EOF
          {         
            pages {
              single (id:27) {
                tags { tag }
              }
            }
          }
          EOF
          )

          JSON_PAYLOAD=$(jq -n --arg q "$QUERY" '{query: $q}')

          RESPONSE=$(curl -s -X POST "https://wiki.franquinho.info/graphql" \
            -H "Authorization: Bearer $WIKI_API_TOKEN" \
            -H "Content-Type: application/json" \
            --data "$JSON_PAYLOAD")

          TAGS=$(echo "$RESPONSE" | jq -c '[.data.pages.single.tags[].tag]')
          echo "TAGS=$TAGS" >> "$GITHUB_ENV"

      - name: Prepare GraphQL Payload
        env:
          TAGS: ${{ env.TAGS }}
        run: |
          echo "üõ† Preparing GraphQL payload..."

          GRAPHQL_QUERY=$(cat << 'EOF'
          mutation UpdatePage($id: Int!, $content: String!, $tags: [String!]) {
            pages {
              update(
                id: $id,
                content: $content,
                editor: "markdown",
                isPrivate: false,
                isPublished: true,
                locale: "en",
                tags: $tags
              ) {
                responseResult {
                  succeeded
                  slug
                  message
                }
                page {
                  id
                  title
                  path
                  updatedAt
                }
              }
            }
          }
          EOF
          )

          RAW_CONTENT=$(cat content_to_upload.md)

          VARIABLES=$(jq -n \
            --arg id "28" \
            --arg content "$RAW_CONTENT" \
            --argjson tags "$TAGS" \
            '{id: ($id | tonumber), content: $content, tags: $tags}')

          echo "$GRAPHQL_QUERY" > query.graphql
          echo "$VARIABLES" > variables.json

      - name: Upload Content to Wiki.js
        env:
          WIKI_API_TOKEN: ${{ secrets.WIKI_API_TOKEN }}
        run: |
          echo "üöÄ Uploading updated content to Wiki.js..."

          JSON_PAYLOAD=$(jq -n \
            --arg query "$(cat query.graphql)" \
            --argjson variables "$(cat variables.json)" \
            '{query: $query, variables: $variables}')

          curl -X POST "https://wiki.franquinho.info/graphql" \
            -H "Authorization: Bearer $WIKI_API_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD"

          echo "‚úÖ Upload complete."
